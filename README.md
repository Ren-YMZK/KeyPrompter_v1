# Key Visualizer

キーボードおよびマウス入力をリアルタイムに可視化するためのシンプルなオーバーレイツールです。
画面最前面に小さなウィンドウを常時表示し、直近の入力履歴と実行したコマンドラインを視覚的に確認できます。

配信・画面共有・ハンズオン解説・ペアプロなどの場面で、「いま何を押したのか」を相手に伝える用途を想定しています。

---

## 特徴

- 常に最前面に表示される小さなウィンドウ（Tkinter）
- キーボード入力の履歴表示（最大 100 件）
  - 直近 30 件を右寄せタイムライン風に表示
  - 同じキーが連続した場合は `K ×N` の形式で圧縮
- 修飾キーの明示的な表示
  - `Ctrl+Shift+Alt+Cmd` の固定順で表示
  - `Shift+A` なら上段に修飾情報、下段にキー本体を表示
- マウスクリックの可視化
  - 左クリック: `Left Click`
  - 右クリック: `Right Click`
  - 中クリック: `Middle Click`
- 直前に入力したコマンドラインの検出・表示
  - `ls`, `cd`, `git`, `python`, `npm` など、代表的なシェルコマンドを多数登録済み
  - コマンド名＋スペース以降の文字列を「直前のコマンド」として画面下部に表示
- コマンドのワンクリックコピー
  - 下部の「直前のコマンド: ...」をクリックすると、そのコマンドがクリップボードにコピーされる
- Ctrl+Backspace の「単語削除」対応
  - バッファ内で、直近の単語単位で削除する挙動をエミュレート
- スレッド安全なイベント処理
  - `pynput`（別スレッド）からのイベントを `queue.Queue` で Tk メインスレッドに渡し、約 60fps で反映

---

## 動作イメージ

- 上段: 修飾キーの情報（例: `Ctrl+Shift+/`, `Shift+1` など）
- 中段: 押下したキー履歴（同一連続は `×N` で圧縮）
- 下段: 水平線より下に「直前のコマンド: ...」を表示

---

## 前提条件

- Python 3.8 以降（目安）
- デスクトップ環境（X11 / Wayland / Windows / macOS）
- 依存ライブラリ:
  - `tkinter`（通常は Python に同梱）
  - `pynput`

---

## インストール

```bash
pip install pynput
```

`tkinter` は多くの環境で標準インストールされていますが、
入っていない場合は OS ごとのパッケージマネージャで追加してください。

---

## 使い方

1. このリポジトリをクローンまたはスクリプトを保存します。
2. 依存パッケージをインストールします。
3. スクリプトを実行します。

```bash
python keyprompter_v1.py
```

実行すると、画面上に横長のウィンドウが最前面で表示されます。

### 基本操作

- キーボードで入力すると、その履歴が右側から追加されていきます。
- マウスでクリックすると、そのクリック種別が履歴に表示されます。
- シェルでコマンドを入力して `Enter` を押すと、直前行のコマンドが下部に表示されます。
- 下部の「直前のコマンド: ...」部分をクリックすると、そのコマンドがクリップボードにコピーされます。

---

## キーバインド・表示仕様

### 修飾キー

内部的には以下の修飾キーをトラッキングしています。

- `ctrl`
- `shift`
- `alt`
- `cmd`

表示時には以下の順序で整列されます。

- `Ctrl` → `Shift` → `Alt` → `Cmd`

例:

- `Ctrl` + `Shift` + `/` → 上段に `Ctrl+Shift+/`
- `Shift` + `a` → 下段に `A`、上段に `Shift+A`

### 連続入力の圧縮

同じ `(キー, 修飾表示)` の組み合わせが連続した場合は、履歴上で 1 つにまとめ、末尾に `×N` を付けて表示します。

例:

- `a` を 3 回入力 → `a ×3`
- `Left Click` を 5 回 → `Left Click ×5`

### コマンド検出

`registered_commands` に定義したコマンド（末尾スペース付き）をもとに、
`Enter` 押下時に `command_buffer` から「直前のコマンド行」を抽出します。

- 例: `git status` と入力して `Enter` → `git ` が検出され、`git status` 以降の文字列が「直前のコマンド」となります。
- 抽出時には末尾の空白を削除してから表示・コピーに使用します。

登録されている主なコマンド例:

- ファイル操作: `ls`, `cd`, `cp`, `mv`, `rm`, `mkdir`, `touch`, `find`, `stat`, `tree` など
- システム情報: `top`, `htop`, `free`, `df`, `du`, `uptime`, `whoami`, `uname`, `hostname`, `id` など
- ネットワーク: `ping`, `curl`, `wget`, `nslookup`, `dig`, `traceroute`, `ip`, `ifconfig`, `netstat`, `ss` など
- パッケージ管理: `apt`, `yum`, `dnf`, `pacman`, `brew`, `pip`, `pip3`, `cargo` など
- 開発関連: `git`, `python`, `node`, `npm`, `yarn`, `gcc`, `g++`, `java`, `javac`, `make` など
- その他: `ssh`, `scp`, `rsync`, `sftp`, `alias`, `history`, `clear`, `echo`, `date`, `time`, `man`, `which` など

---

## 実装メモ

- キー・マウスイベントは `pynput` のリスナーから取得し、`Queue` に積んだ上で Tk のメインスレッド側で処理しています。
  - これにより Tkinter とスレッドの相性問題を回避しています。
- `pump()` 関数が約 60 fps（`root.after(16, ...)`）でキューをポーリングし、画面を更新します。
- `command_buffer` は最大 `MAX_BUF` 文字までに制限し、長時間の利用でもメモリが伸び続けないようにしています。
- ウィンドウを閉じるときは `WM_DELETE_WINDOW` に `on_close` を登録し、`pynput` のリスナーを停止してから Tk を破棄しています。

---

## 制限事項・注意点

- OS によっては、一部の特殊キーや IME 絡みの入力が正しく拾えない場合があります。
- `pynput` はグローバルフックを使うため、環境によっては権限の設定が必要な場合があります。
- ウィンドウの透明化やクリック透過などは現状行っていません。必要であれば Tk のウィンドウ属性を追加してください。
